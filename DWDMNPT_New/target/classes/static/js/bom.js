var dummyJson = {
  NodeCount: "3",
  NodeData: ["1", "2", "3"],
  bomViewData: [
    {
      NodeId: "1",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "A",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "1",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "A",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "1",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "A",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "1",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "A",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "1",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "A",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "2",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "2",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "2",
      StationName: "Chatsadtarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "2",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "2",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "2",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "3",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "3",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "3",
      StationName: "Chattsadarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "3",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "3",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      NodeId: "3",
      StationName: "Chattarpur",
      SiteName: "New Delhi",
      Name: "",
      Quantity: "2",
      Price: "1500",
      TotalPrice: "3000",
      PartNo: "X",
      RevisionCode: "Y",
      Category: "1"
    }
  ],
  equipmentDbData: [
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    },
    {
      Name: "X",
      PartNo: "Y",
      PowerConsumption: "100",
      SlotSize: "2",
      Details: "Z",
      Price: "1000",
      RevisionCode: "Y",
      Category: "1"
    }
  ],
  equipmentPrefDbData: [
    {
      NodeId: 1,
      CardFeature: "WSS",
      CardType: "wss1x2",
      EquipmentId: "5",
      Preference: "1"
    },
    {
      NodeId: 1,
      CardFeature: "MPN",
      CardType: "mux",
      EquipmentId: "2",
      Preference: "1"
    },
    {
      NodeId: 2,
      CardFeature: "WSS",
      CardType: "wss1x2",
      EquipmentId: "17",
      Preference: "1"
    },
    {
      NodeId: 2,
      CardFeature: "MPN",
      CardType: "mux",
      EquipmentId: "20",
      Preference: "1"
    },
    {
      NodeId: 3,
      CardFeature: "WSS",
      CardType: "wss1x2",
      EquipmentId: "5",
      Preference: "1"
    },
    {
      NodeId: 3,
      CardFeature: "MPN",
      CardType: "mux",
      EquipmentId: "2",
      Preference: "1"
    }
  ]
};

var currentJsonObj = [],
  isEquipmentData = 0;

$("#bomModalTrigger").on("click", function() {
  //$('#bomModal').modal('show');
  console.log("BomModal Loaded");
  $("#bomModal").modal({ backdrop: "static", keyboard: false }); //disable click on black area/ esc key
  //equipmentDbAjaxCall();
  //finitializeBomView();
  bomDbAjaxCall();
});

$("#equipmentTrigger").on("click", function() {
  equipmentDbAjaxCall();
});

$("#savePreferencesBom").on("click", function() {
  saveEquipmentPrefToDatabase();
});

/**
 * Function to generate Config File for the current network nodes
 */
$("#configFileGenerationTrigger").on("click", function() {
  let postData = jsonPostObject();

  fShowClientServerCommunicationModal("Generating Control Path Files ... ");

  serverPostMessage("configFileGenerationRequest", postData)
    .then(function(data) {
      if (data == nptGlobals.Success) {
        fShowSuccessMessage(
          "Generated Successfully in Download/ConfigPathFiles/ControlPathFiles Directory"
        );
      } else if (data == nptGlobals.Failure) {
        fShowFailureMessage(
          "Control Path Files couldn't be Generated Successfully! "
        );
      }
    })
    .catch(function(e) {
      console.log(e);
    });
});

/**
 * Function to generate Config File for the current network nodes
 */
$("#datapathConfigFileGenerationTrigger").on("click", function() {
  let postData = jsonPostObject();

  fShowClientServerCommunicationModal("Generating Data Path Files ... ");

  serverPostMessage("datpathConfigFileGenerationRequest", postData)
    .then(function(data) {
      if (data == nptGlobals.Success) {
        fShowSuccessMessage(
          "Generated Successfully in Download/ConfigPathFiles/DataPathFiles Directory"
        );
      } else if (data == nptGlobals.Failure) {
        fShowFailureMessage(
          "Data Path Files couldn't be Generated Successfully! "
        );
      }
    })
    .catch(function(e) {
      console.log(e);
    });
});

/**
 * Function to generate All Config File Under One Directory for the current network nodes
 */
$("#combinedConfigFileGenerationTrigger").on("click", function() {
  let postData = jsonPostObject();

  fShowClientServerCommunicationModal("Generating Data Path Files .... ");

  serverPostMessage("combinedConfigFileGenerationTrigger", postData)
    .then(function(data) {
      if (data == nptGlobals.Success) {
        fShowSuccessMessage("Generated Successfully in Download Directory");
      } else if (data == nptGlobals.Failure) {
        fShowFailureMessage("Couldn't be Generated Successfully! ");
      }
    })
    .catch(function(e) {
      console.log(e);
    });

  //	var dialog = new joint.ui.Dialog({
  //	    width: 300,
  //	    title: 'My title',
  //	    content: 'This is my dialog box.'
  //	});
  //	dialog.open();
});

/**
 * Function to Transfer Configuration File To EMS Node
 */
$("#configFileSendToEMSTrigger").on("click", function() {
  //console.log("configFileSendToEMSTrigger clicked");
  configFileSendToEMSAjaxCall();
});

var bomDbAjaxCall = function() {
  serverGetMessage("getBOMJsonDataRequest")
    .then(function(data) {
      dummyJson = data;
      console.log("success Data:", data);
      finitializeBomView();
      fUpdateEquipmentPreferences();
    })
    .catch(function(e) {
      console.log("fail", e);
    });

  // $.ajax({

  // 	type: "GET",
  //     contentType: "application/json",

  //     headers: {
  //         Accept : "application/json; charset=utf-8",
  //        "Content-Type": "application/json; charset=utf-8"
  //     } ,

  //    url: "/getBOMJsonDataRequest",

  //    timeout: 600000,

  //    success: function (data) {

  // 	   dummyJson=data;
  // 	   console.log(data);
  // 	   console.log("success");
  // 	   finitializeBomView();
  // 	   fUpdateEquipmentPreferences();
  //    },

  //    error: function (e) {
  // 	   console.log("fail");
  // 	   console.log(e);  }
  // 	});
};

var equipmentDbAjaxCall = function() {
  console.log("equipmentDbAjaxCall");

  let postData = jsonPostObject();
  postData.Step = "Initialize";
  var timeLog = "\n";
  // fShowClientServerCommunicationModal("Generating inventory. This might take some time , even a few minutes depending on the network map size.");
  fShowClientServerCommunicationModal("Initializing nodes and links ....");
  serverPostMessage("generateEquipment", postData)
    .then(function(data) {
      // data=JSON.parse(JSON.stringify(data));
      console.log("generateEquipment Request success ", data);
      if (data.ResponseStatus == 0) {
        // fShowFailureMessage("RWA generated paths have errors. First correct those errors or make necessary changes to circuits in order to generate equipment.");
        //  reject("Finish");
        throw "RWA Error";
      } else if (data.ResponseStatus == 1) {
        timeLog += postData.Step + " -->" + data.Time + "\n";
        fShowClientServerCommunicationModal("Assigning common cards ...");
        postData.Step = "CommonCards";
        return serverPostMessage("generateEquipment", postData);
      }
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal("Assigning potp cards ...");
      postData.Step = "Potp";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal("Assigning muxponder cards ...");
      postData.Step = "Mux/Demux";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal("Assigning OLP cards ...");
      postData.Step = "OLP";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal("Assigning OTDR cards ...");
      postData.Step = "OTDR";
      return serverPostMessage("generateEquipment", postData);
    })
    // .then(function(data){
    // 	timeLog+=postData.Step+" -->"+data.Time+"\n";
    // 	fShowClientServerCommunicationModal("Assigning mux/demux trays and port on cards...");
    // 	postData.Step="TRAYS";
    // 	return serverPostMessage("generateEquipment", postData);
    // })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal(
        "Assigning ports on cards,trays and add/drop cards ..."
      );
      postData.Step = "ADD/DROP&TRAYS";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal("Assigning ports on cards ...");
      postData.Step = "PORTMAPPING";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal("Assigning patch cords ...");
      postData.Step = "PATCHCORDS";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowClientServerCommunicationModal(
        "Winding up and Optimizing resource allocation ..."
      );
      postData.Step = "FINISH";
      return serverPostMessage("generateEquipment", postData);
    })
    .then(function(data) {
      timeLog += postData.Step + " -->" + data.Time + "\n";
      fShowSuccessMessage("Equipment Generated Successfully.");
      nptGlobals.setInventoryGenerated(true);
      //   window.isInventoryGenerated = 1;
      //   fNptStateChange(isInventoryGeneratedStr);
    })
    .catch(function(e) {
      console.log("Error", e);
      if (e == "RWA Error")
        fShowWarningMessage(
          "RWA generated paths have errors. First correct those errors or make necessary changes to circuits in order to generate equipment."
        );
      else fShowFailureMessage("Error in Equipment Generation Process.");
    });
};

/**
 * MULTIPART Req Ajax call to Transfer Uploaded file to EMS Server
 */
var configFileSendToEMSAjaxCall = function() {
  //console.log("Inside configFileSendToEMSAjaxCall ..");

  $("#configFileSendToEmsModal").modal({
    backdrop: "static",
    keyboard: true
  });
};

/***************************************************************************/
/**         Ajax call for saving equipment Preferences                    **/
/***************************************************************************/
var fAjaxCallSaveEquipmentPref = function(finaljsonobj) {
  //fShowClientServerCommunicationModal("Saving Equipment Preferences. This might take few minutes.");
  //fSavingPreferenceAlert();
  disableCloseButton(true);
  fShowClientServerCommunicationModal("Saving Preferences....");
  $.ajax({
    type: "POST",
    contentType: "application/json",

    headers: {
      Accept: "application/json; charset=utf-8",
      "Content-Type": "application/json; charset=utf-8"
    },

    url: "/viewBomSaveEquipmentPref",
    data: JSON.stringify(finaljsonobj),
    dataType: "json",
    timeout: 600000,

    success: function(data) {
      console.log("Equipment Pref saved successfully");
      console.log(data);
      dummyJson = data;
      finitializeBomView();
      /*$("#modalLoadingContent img").attr('src','images/success.png');
			$("#modalLoadingContent p").text("Equipment Preference saved Successfully ");*/

      /*$(".savePreferencesAlert").empty().append("Preferences Saved Successfully");	
			setTimeout(function() {
				   // code to be executed after 2 second
				$(".savePreferencesAlert").empty();
				 }, 2000);*/
      disableCloseButton(false);
      fadeOutModal(); /**Added to auto close modal*/

      $("#modalLoadingContent img").attr("src", "images/success.png");
      $("#modalLoadingContent p").text("Preferences Saved Successfully.");
      fDisableSavepreferenceBtn(false); //false for active
    },

    error: function(e) {
      /*$("#modalLoadingContent img").attr('src','images/failure.png');
			$("#modalLoadingContent p").text("Equipment Preference could not be saved Successfully.");*/
      console.log("Equipment Preference saving failure" + e);
      disableCloseButton(false);
      ///fadeOutModal();/**Added to auto close modal*/
      $("#modalLoadingContent img").attr("src", "images/failure.png");
      $("#modalLoadingContent p").text(
        "Preferences couldn't be saved successfully."
      );
      /*$(".savePreferencesAlert").empty().append("Preferences Saving Failure");	
			setTimeout(function() {
				   // code to be executed after 2 second
				$(".savePreferencesAlert").empty();
				 }, 2000);*/
    }
  });
};

/*var fSavingPreferenceAlert=function(){
	var alerttext=`Saving Preferences <img class="cardPrefAlerttextImage"src="../images/load.gif">`;
	$(".savePreferencesAlert").empty().append(alerttext);	
}
*/

/***************************************************************************/
/**         Bom/equipment/pref initialization                             **/
/***************************************************************************/
var finitializeBomView = function() {
  //console.log("Data ");
  console.log("Inside finitializeBom View");
  var nodejsonArray = dummyJson.NodeData;
  $("#bomNodeId").empty();

  for (var i = 0; i < nodejsonArray.length; i++)
    $("#bomNodeId").append(
      `<option value="${nodejsonArray[i]}">${nodejsonArray[i]}</option>`
    );
  $("#bomNodeId").prepend(`<option value="All">All</option>`);

  fGenerateBomDataForNode(nodejsonArray[0]);
  //var NodeDataForBomArr=dummyJson.bomViewData['1'];

  var equipmentListArr = dummyJson.equipmentDbData;
  //console.log("equipmentListArr")
  //console.log(equipmentListArr)

  $(".modalBodyBomContentPanelEquipmentTable tbody").empty();
  var str = "";
  for (var i = 0; i < equipmentListArr.length; i++) {
    str += `<tr>
		<td>${equipmentListArr[i].Name}</td>
		<td>${equipmentListArr[i].PartNo}</td>
		<td>${equipmentListArr[i].PowerConsumption}</td>
		<td>${equipmentListArr[i].SlotSize}</td>
		<td>${equipmentListArr[i].Details}</td>
		<td>${equipmentListArr[i].Price}</td>
		<td>${equipmentListArr[i].RevisionCode}</td>
		<td>${equipmentListArr[i].Category}</td>
		</tr>`;
    //console.log(str);
  }
  $(".modalBodyBomContentPanelEquipmentTable tbody").append(str);

  fDisableSavepreferenceBtn(true); //disable save preference button
};

/***************************************************************************/
/**         save equipment Preferences trigger                            **/
/***************************************************************************/
var saveEquipmentPrefToDatabase = function(val) {
  var jsonEquipmentPref = [];
  var equipmentPrefTableData = $(
    ".modalBodyBomContentPanelEquipmentPrefTable tbody form"
  );
  $(".modalBodyBomContentPanelEquipmentPrefTable tbody form").each(function(
    index
  ) {
    var nodeId = $(this)
      .attr("id")
      .match(/\d+/); //get node Id
    console.log("Node Id ==" + nodeId);

    $(this)
      .find("select")
      .each(function() {
        console.log($(this));
        var jsonEquipmentPrefNodeObj = {};
        jsonEquipmentPrefNodeObj.NodeId = nodeId[0]; //set node id
        var id = $(this).attr("id");

        console.log("Select input val :" + $(this).val());

        if (~id.indexOf("WSS")) jsonEquipmentPrefNodeObj.cardFeature = "WSS";
        //set cardFeature
        else if (~id.indexOf("MPN"))
          jsonEquipmentPrefNodeObj.cardFeature = "MPN"; //set cardFeature

        jsonEquipmentPrefNodeObj.eqId = $(this).val(); //set eqId

        jsonEquipmentPref.push(jsonEquipmentPrefNodeObj); //push object to cardPrefArr
      });
  });

  var finaljsonobj = {};
  finaljsonobj.prefData = jsonEquipmentPref; //final object
  console.log("Finaljsonobj for Saving equipment preferences");
  console.log(finaljsonobj);

  fAjaxCallSaveEquipmentPref(finaljsonobj); //ajax call for saving preferences to db
  //bootbox.hideAll();
  /*setTimeout(function() {
	   //your code to be executed after 1 second
	   equipmentDbAjaxCall();
	 }, 5000);*/
  //bootbox.hideAll();
  /* setTimeout(function() {
	   //your code to be executed after 1 second
	   bomDbAjaxCall();
	 }, 5000);*/

  //bootbox.hideAll();
};

/***************************************************************************/
/**         Tab menu trigger for bom view                                **/
/***************************************************************************/
$("#modalBodyBomTabMenuBomTrigger").on("click", function() {
  $("#modalBodyBomContentPanelEquipment").slideUp();
  $("#modalBodyBomContentPanelEquipmentPref").slideUp();
  $("#modalBodyBomContentPanelBom").slideDown();

  $("#modalBodyBomHeadPanel *").prop("disabled", false);
  fDisableSavepreferenceBtn(true);

  // console.log($(this));
  fActiveClassToggleForBomModalTabMenu($(this));

  currentJsonObj = fGetNodeWiseBomViewData(
    dummyJson.bomViewData,
    $("#bomNodeId").val()
  );
  isEquipmentData = 0;

  $("#bomViewMainHeading").html("Equipment Data");
});

$("#modalBodyBomTabMenuEquipmentTrigger").on("click", function() {
  $("#modalBodyBomContentPanelBom").slideUp();
  $("#modalBodyBomContentPanelEquipmentPref").slideUp();
  $("#modalBodyBomContentPanelEquipment").slideDown();
  $("#bomViewMainHeading").html("Equipment List");

  $("#modalBodyBomHeadPanel *").prop("disabled", true);
  //$('#modalBodyBomHeadPanel').fadeTo('slow',.6);
  //$('#modalBodyBomHeadPanel').append('<div style="position: absolute;top:0;left:0;width: 100%;height:100%;z-index:2;opacity:0.4;filter: alpha(opacity = 50)"></div>');

  //console.log($(this));
  fActiveClassToggleForBomModalTabMenu($(this));

  fDisableSavepreferenceBtn(true);

  ///currentJsonObj=dummyJson.equipmentDbData;
  isEquipmentData = 1;
});

$("#modalBodyBomTabMenuEquipmentPrefTrigger").on("click", function() {
  $("#modalBodyBomContentPanelEquipment").slideUp();
  $("#modalBodyBomContentPanelBom").slideUp();
  $("#modalBodyBomContentPanelEquipmentPref").slideDown();
  fUpdateEquipmentPreferences(); // call to update preferences
  $("#bomViewMainHeading").html("Equipment Preference List");

  $("#modalBodyBomHeadPanel *").prop("disabled", true);

  // console.log($(this));
  fActiveClassToggleForBomModalTabMenu($(this));

  fDisableSavepreferenceBtn(false);
});

var fActiveClassToggleForBomModalTabMenu = function($el) {
  //console.log($el.siblings())
  $el.siblings().each(function() {
    $(this).removeClass("activeFocus");
  });
  $el.addClass("activeFocus");
};

/***************************************************************************/
/**       Preference Tab Data filling                                     **/
/***************************************************************************/
var fUpdateEquipmentPreferences = function() {
  console.log("DummyJson :" + dummyJson);
  var jsonEqPrefArray = dummyJson.equipmentPrefDbData;
  //var jsonEqPrefArray=fAjaxCallFetchEquipmentPref();
  //preferences tab
  str = "";
  //$(".modalBodyBomContentPanelEquipmentPrefTable tbody").empty();
  var temp = 0,
    currNodeId;
  while (temp < jsonEqPrefArray.length) {
    currNodeId = jsonEqPrefArray[temp].NodeId;
    console.log("value of temp=" + temp);
    str += `<tr>
		<td>${jsonEqPrefArray[temp].NodeId}</td>`;
    str += `<td><form class="form-inline" id="prefForm${
      jsonEqPrefArray[temp].NodeId
    }">`;
    while (
      temp < jsonEqPrefArray.length &&
      jsonEqPrefArray[temp].NodeId == currNodeId
    ) {
      //str+=``;
      if (jsonEqPrefArray[temp].CardFeature == "WSS") {
        str += `<div class="form-group">
			<label for="${jsonEqPrefArray[temp].CardFeature}${
          jsonEqPrefArray[temp].NodeId
        }">${jsonEqPrefArray[temp].CardFeature}</label> 
			<select	class="form-control cardPref" id="${jsonEqPrefArray[temp].CardFeature}${
          jsonEqPrefArray[temp].NodeId
        }">
			<option value="5">Wss 2x1X9</option>
            <option value="16">Wss 1X2</option>
			<option value="17">Wss 2x1x20</option>												
			</select>
			</div>`;
      } else if (jsonEqPrefArray[temp].CardFeature == "MPN") {
        str += `<div class="form-group">
			<label for="${jsonEqPrefArray[temp].CardFeature}${
          jsonEqPrefArray[temp].NodeId
        }">${jsonEqPrefArray[temp].CardFeature}</label> 
			<select	class="form-control cardPref" id="${jsonEqPrefArray[temp].CardFeature}${
          jsonEqPrefArray[temp].NodeId
        }">
			<option value="2">CGM</option>		
			<option value="20">CGX</option>										
			</select>
			</div>`;
      }
      temp++;
    }
    str += `</form></td></tr>`;
  }
  console.log(str);
  $(".modalBodyBomContentPanelEquipmentPrefTable tbody")
    .empty()
    .append(str);

  fInitializeEquipmentPreftab(); //initialize card preference input values
};

/***************************************************************************/
/**       Initialize data of Preference Tab                              **/
/***************************************************************************/
var fInitializeEquipmentPreftab = function() {
  var EqupmentPrefArray = dummyJson.equipmentPrefDbData;
  $(".modalBodyBomContentPanelEquipmentPrefTable tbody")
    .find("select")
    .each(function(index) {
      console.log("Index :" + index);
      console.log(EqupmentPrefArray[index].EquipmentId);
      $(this).val(EqupmentPrefArray[index].EquipmentId);
    });
};

/***************************************************************************/
/**         Node Id change trigger for bom data                           **/
/***************************************************************************/
$("#bomNodeId").on("change", function() {
  var NodeId = $(this).val(); //fGenerateBomDataForCompleteSystem

  $("#modalBodyBomContentPanelBom").slideUp();
  $("#modalBodyBomContentPanelEquipment").slideUp();
  $("#modalBodyBomContentPanelEquipmentPref").slideUp();
  $("#modalBodyBomContentPanelBom").slideDown();

  if (NodeId == "All") fGenerateBomDataForCompleteSystem();
  else fGenerateBomDataForNode(NodeId);

  $("#modalBodyBomTabMenuBomTrigger").addClass("activeFocus");
  $("#modalBodyBomTabMenuEquipmentTrigger").removeClass("activeFocus");
  $("#modalBodyBomTabMenuEquipmentPrefTrigger").removeClass("activeFocus");
  console.log("NodeId ::" + NodeId);
});

/***************************************************************************/
/**         Enable/Disable the save preference button                    **/
/***************************************************************************/
var fDisableSavepreferenceBtn = function(val) {
  $("#savePreferencesBom").prop("disabled", val);
  $("#downloadBomViewData").prop("disabled", !val);
  $("#downloadPdfBomViewData").prop("disabled", !val);
};

/***************************************************************************/
/**         get bom data for a ( NodeId == 1,2,3 etc ) option             **/
/***************************************************************************/
var fGetNodeWiseBomViewData = function(NodeDataForBomArrComplete, NodeId) {
  var NodeDataForBomArr = [];
  for (var j = 0; j < NodeDataForBomArrComplete.length; j++) {
    if (NodeDataForBomArrComplete[j].NodeId == NodeId)
      NodeDataForBomArr.push(NodeDataForBomArrComplete[j]);
  }
  return NodeDataForBomArr;
};

/***************************************************************************/
/**         Generate bom data for a given NodeId                          **/
/***************************************************************************/

//var fGenerateBomDataForNode=function(NodeId)
//{
//	//var NodeDataForBomArr=dummyJson.bomViewData[NodeId];
//	var NodeDataForBomArrComplete=dummyJson.bomViewData;
//	if(NodeDataForBomArrComplete.length==0)
//		console.log("Bom Data Empty");
//
//	var NodeDataForBomArr=[];
//	NodeDataForBomArr=fGetNodeWiseBomViewData(NodeDataForBomArrComplete,NodeId);
//
//	var StationName=NodeDataForBomArr[0].StationName;
//	var SiteName=NodeDataForBomArr[0].SiteName;
//	var TotalCost=0;
//	var TotalPower=0;
//	var TotalTypicalPower=0;
//	console.log("NodeDataForBomArr")
//	console.log(NodeDataForBomArr)
//
//	currentJsonObj=NodeDataForBomArr;
//	isEquipmentData=0;
//
//	var header=`<tr>
//		<th>Name</th>
//		<th>Quantity</th>
//		<th>Unit Price ($)</th>
//		<th>Total Price ($)</th>
//		<th>Part No.</th>
//		<th>Revision Code</th>
//		<th>Category</th>
//		</tr>`;
//	$(".modalBodyBomContentPanelBomTable thead").empty().append(header);
//	$(".modalBodyBomContentPanelBomTable tbody").empty();
//	var str='';
//	for(var i=0;i<NodeDataForBomArr.length;i++)
//		{
//		str+=`<tr>
//			<td>${NodeDataForBomArr[i].Name}</td>
//			<td>${NodeDataForBomArr[i].Quantity}</td>
//			<td>${NodeDataForBomArr[i].Price}</td>
//			<td>${NodeDataForBomArr[i].TotalPrice}</td>
//			<td>${NodeDataForBomArr[i].PartNo}</td>
//			<td>${NodeDataForBomArr[i].RevisionCode}</td>
//			<td>${NodeDataForBomArr[i].Category}</td>
//			</tr>`;
//		TotalCost=TotalCost+Number(NodeDataForBomArr[i].TotalPrice);
//		TotalPower=TotalPower+Number(NodeDataForBomArr[i].PowerConsumption);
//		TotalTypicalPower=TotalTypicalPower+Number(NodeDataForBomArr[i].TypicalPowerConsumption);
//		}
//	$(".modalBodyBomContentPanelBomTable").addClass('table-striped');
//	$(".modalBodyBomContentPanelBomTable tbody").append(str);
//
//	$("#bomSiteName").html(SiteName.toUpperCase());
//	$("#bomStationName").html(StationName.toUpperCase());
//	$("#bomTotalCost").html(TotalCost + "US Dollars");
//	$("#bomPowerCons").html(TotalPower);
//	$("#bomPowerConsTypical").html(TotalTypicalPower);
//	}
//

/***************************************************************************/
/**         Generate bom data for a ( NodeId == All ) option              **/
/***************************************************************************/
//var fGenerateBomDataForCompleteSystem=function()
//{
//	//var NodeDataForBomArr=dummyJson.bomViewData[NodeId];
//	var NodeDataForBomArrComplete=dummyJson.bomViewData;
//    var bomArrLength=NodeDataForBomArrComplete.length;
//	var TotalCost=0;
//	var TotalPower=0;
//	console.log("NodeDataForBomArrComplete")
//	console.log(NodeDataForBomArrComplete)
//
//	currentJsonObj=NodeDataForBomArrComplete;
//	isEquipmentData=0;
//
//	var header=`<tr>
//	    <th>Node Id</th>
//		<th>Name</th>
//		<th>Quantity</th>
//		<th>Unit Price ($)</th>
//		<th>Total Price ($)</th>
//		<th>Part No.</th>
//		<th>Revision Code</th>
//		<th>Category</th>
//		</tr>`;
//	$(".modalBodyBomContentPanelBomTable thead").empty().append(header);
//	$(".modalBodyBomContentPanelBomTable tbody").empty();
//	var str='';
//    var className='bomRowBkgColor1';
//	for(var i=0;i<bomArrLength;i++)
//		{
//		console.log("value of i at strating ::"+i)
//		var currNodeId=NodeDataForBomArrComplete[i].NodeId;
//		//var j=i+1;
//		while(i<bomArrLength && currNodeId==NodeDataForBomArrComplete[i].NodeId)
//			{
//			str+=`<tr class="${className}">
//			    <td>${NodeDataForBomArrComplete[i].NodeId}</td>
//				<td>${NodeDataForBomArrComplete[i].Name}</td>
//				<td>${NodeDataForBomArrComplete[i].Quantity}</td>
//				<td>${NodeDataForBomArrComplete[i].Price}</td>
//				<td>${NodeDataForBomArrComplete[i].TotalPrice}</td>
//				<td>${NodeDataForBomArrComplete[i].PartNo}</td>
//				<td>${NodeDataForBomArrComplete[i].RevisionCode}</td>
//				<td>${NodeDataForBomArrComplete[i].Category}</td>
//				</tr>`;
//			TotalCost=TotalCost+Number(NodeDataForBomArrComplete[i].TotalPrice);
//			TotalPower=TotalPower+Number(NodeDataForBomArrComplete[i].PowerConsumption);
//			i++;
//			}
//		i--;
//		if(className=='bomRowBkgColor1')
//			className='bomRowBkgColor2';
//		else className='bomRowBkgColor1';
//		//console.log("value of i at last : "+i + "\n str value :"+str);
//		}
//
//	$(".modalBodyBomContentPanelBomTable").removeClass('table-striped');
//	$(".modalBodyBomContentPanelBomTable tbody").append(str);
//
//	$("#bomSiteName").html("NA");
//	$("#bomStationName").html("NA");
//	$("#bomTotalCost").html(TotalCost);
//	$("#bomPowerCons").html(TotalPower);
//	$("#bomPowerConsTypical").html(TotalPower);
//	console.log("value of bomPowerCons ::"+TotalPower + "value of totalCost :: "+TotalCost)
//
//	 $(".modalBodyBomContentPanelBomTable").tablesorter();
//	}

function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel) {
  //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
  var arrData = typeof JSONData != "object" ? JSON.parse(JSONData) : JSONData;

  var CSV = "";
  //Set Report title in first row or line

  CSV += ReportTitle + "\r\n\n";

  //This condition will generate the Label/Header
  if (ShowLabel) {
    var row = "";

    //This loop will extract the label from 1st index of on array
    for (var index in arrData[0]) {
      //Now convert each value to string and comma-seprated
      row += index + ",";
    }

    row = row.slice(0, -1);

    //append Label row with line break
    CSV += row + "\r\n";
  }

  //1st loop is to extract each row
  for (var i = 0; i < arrData.length; i++) {
    var row = "";

    //2nd loop will extract each column and convert it in string comma-seprated
    for (var index in arrData[i]) {
      row += '"' + arrData[i][index] + '",';
    }

    row.slice(0, row.length - 1);

    //add a line break after each row
    CSV += row + "\r\n";
  }

  if (CSV == "") {
    alert("Invalid data");
    return;
  }

  //Generate a file name
  var fileName = "MyReport_";
  //this will remove the blank-spaces from the title and replace it with an underscore
  fileName += ReportTitle.replace(/ /g, "_");

  //Initialize file format you want csv or xls
  var uri = "data:text/csv;charset=utf-8," + escape(CSV);

  // Now the little tricky part.
  // you can use either>> window.open(uri);
  // but this will not work in some browsers
  // or you will not get the correct file extension

  //this trick will generate a temp <a /> tag
  var link = document.createElement("a");
  link.href = uri;

  //set the visibility hidden so it will not effect on your web-layout
  link.style = "visibility:hidden";
  link.download = fileName + ".xls";

  //this part will append the anchor tag and remove it after automatic click
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

$("#downloadBomViewData").click(function() {
  JSONToCSVConvertor(
    /*dummyJson.bomViewData*/ currentJsonObj,
    "Bill of Material for System",
    true
  );
});

$("#downloadPdfBomViewData").click(function() {
  var bomData = dummyJson.bomViewData;
  console.log(bomData);
  //printJS({printable: bomData, properties: ['NodeId', 'Name', 'Quantity','Price','TotalPrice','PartNo','Revision Code','Category'], type: 'json'});});
});

$("#bomModal .modal-dialog").resizable({
  //alsoResize: ".modal-dialog",
  minHeight: 300,
  minWidth: 300
});
$("#bomModal .modal-dialog").draggable();

$("#bomModal").on("show.bs.modal", function() {
  $(this)
    .find(".modal-body")
    .css({
      "max-height": "100%"
    });
});
/*$("#bomModal").draggable({
      handle: "#modalBodyBomHeadPanelHeading"
  });*/

var fSaveAsPdfBomData = function() {
  if (isEquipmentData)
    printJS({
      printable: currentJsonObj,
      properties: [
        "Name",
        "PartNo",
        "PowerConsumption",
        "SlotSize",
        "Details",
        "Price",
        "RevisionCode",
        "Category"
      ],
      type: "json"
    });
  else
    printJS({
      printable: currentJsonObj,
      properties: [
        "NodeId",
        "StationName",
        "SiteName",
        "Name",
        "Quantity",
        "Price",
        "TotalPrice",
        "PartNo",
        "RevisionCode",
        "Category"
      ],
      type: "json"
    });
};
